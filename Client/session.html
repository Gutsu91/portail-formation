<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inscrire des stagiaires | Forem Formation</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="additional-style.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous"/>
</head>
<body>
  <header class="navbar has-shadow is-white">
    <figure class="navbar-brand">
      <a href="#" class="navbar-item p-4"><img src="./src/img/Logo-Forem-noir.png" alt="Logo du Forem"></a>
    </figure>
    <nav class="navbar-menu">
      <ul class="navbar-end" id="account-nav-link">
        <li class="navbar-item p-0 login-link"><a href="./login.html" class="navbar-item p-4">Connexion</a></li>
        <li class="navbar-item p-0 ge-link"><a href="./gestion-evaluation.html" class="navbar-item p-4">Remplir la GE</a></li>
        <li class="navbar-item has-dropdown is-hoverable p-0 stagiaire-link">
          <a href="./session.html" class="navbar-item p-4">
          Stagiaire</a>
        <ul class="navbar-dropdown">
          <li class="navbar-item"><a href="./inscrire-stagiaire.html">Inscrire un stagiaire</a></li>
          <li class="navbar-item"><a href="./session.html">Assigner une session</a></li>
        </ul></a></li>
        <li class="navbar-item p-0 session-link"><a href="./formation.html" class="navbar-item p-4">Sessions</a></li>
      </ul>
  </header>
  <main class="columns pt-6" style="min-height:70vh;">
    <section class="column is-8 is-offset-1">
      <h1 class="title">Assigner une session</h1>
      <div class="select my-4">
      <select name="session" id="session" class="sessionSelect">
        <option selected hidden disabled>Sélectionner une session</option>
        <option>INGRWF10</option>
        <option>INGRWC-8</option>
      </select>
    </div>
      <form method="post">
        <div class="field my-4">
          <div class="control has-icons-right">
          <input type="text" class="input is-medium searchfield" placeholder="Cherchez une personne">
          <span class="icon is-small is-right"><i class="fas fa-search"></i></span>
        </div>
      </div>
      </form>
      <table class="table mt-6" style="width:100%;">
        <thead>
          <th style="width:20%">Prénom</th>
          <th style="width:20%">Nom</th>
          <th style="width:60%">Email</th>
          <th style="width:20%">Inscrit</th>
        </thead>
        <tbody class="searchResult">
        </tbody>
      </table>
      <table class="table result-session" style="width:100%">
        <thead style="visibility:hidden;">
          <th style="width:20%">Prénom</th>
          <th style="width:20%">Nom</th>
          <th style="width:60%">Email</th>
          <th style="width:20%">Inscrit</th>
        </thead>
        <tbody class="corps-tableau"></tbody>
      </table>
  </section>
  </main>
  <footer class="footer is-flex is-justify-content-space-between">
    <div class="content">&copy;2022</div>
    <a class="easter-egg">Wazaaah</a>
  </footer>
  <script>
        /* gestion du header */
const loginLink = document.querySelector('.login-link')
const geLink = document.querySelector('.ge-link')
const stagiaireLink = document.querySelector('.stagiaire-link')
const sessionLink = document.querySelector('.session-link')
const sessionSelect = document.querySelector('#session');
const urlApi = 'http://localhost/Formation/API'
const tBody = document.querySelector('.corps-tableau')
const searchField = document.querySelector('.searchfield')
const searchResult = document.querySelector('.searchResult')



    const UserType = sessionStorage.getItem('type_user')
switch(UserType){
  case null :
    window.location.href = './login.html'
    break
  case 'stagiaire':
    stagiaireLink.remove()
    sessionLink.remove()
    break
  default:
    geLink.remove()
    break
}
/*----- fetch des sessions disponibles -----*/
fetch(urlApi + '/session/')
.then(response=>response.json())
.then(response => {
  console.log(response)
  let template ='<option value="0" hidden selected disabled data-id="0">Sélectionner une session</option>'
  response.data.forEach(sess => {
    template +=`
              <option value="${sess.id_session}" data-id=${sess.id_session}>${sess.nom_session} - ${sess.date_debut}</option>
    `
  })
  sessionSelect.innerHTML = template
})
.catch(error=>console.log(error))

/*----- fetch des users inscrits à une session -----*/
sessionSelect.addEventListener('change', (e) => {
  let idSession = sessionSelect.value
  fetch(urlApi + '/inscription/' + idSession)
  .then(response=>response.json())
  .then(response => {
    console.log(response)
    let template = '<tr><td colspan="4" class="has-text-weight-bold">Stagiaires déjà inscrits :</td></tr>'
    response.data.forEach(stagiaire => {
      template += `
        <tr>
                <td>${stagiaire.prenom_user}</td>
                <td>${stagiaire.nom_user}</td>
                <td>${stagiaire.email}</td>
                <td><input type="checkbox" class="checkbox-désinscription checkboxes" checked></td>
              </tr>
    `
    })
    tBody.innerHTML = template
    
    
  })
})

/*----- fetch des users du search -----*/
searchField.addEventListener('keyup', search => {
if(searchField.value.length >= 3) {
  fetch(urlApi + '/search/', {
  header: {'Content-Type' : 'applicaton/json'},
  method: 'POST',
  body: JSON.stringify({search:searchField.value})
})
.then(response=>response.json())
.then(response => {
  console.log(response)
  if(response.response['nbhits'] >= 1) {
    let template =''
    response.data.forEach(found => {
      template +=`
              <tr>
                <td style="width:20%">${found.prenom_user}</td>
                <td style="width:20%">${found.nom_user}</td>
                <td style="width:60%">${found.email}</td>
                <td style="width:20%"><input type="checkbox" class="checkbox-inscription checkboxes" data-id_user="${found.id_user}"></td>
              </tr>
              `
       })
       searchResult.innerHTML = template
  }
  
})
.catch(error=>console.log(error))
}
})

const stagiaireInscrit = document.querySelector('.result-session')
stagiaireInscrit.addEventListener('click', e => {
  if(e.target.classList.contains('checkboxes')) {
      e.target.toggleAttribute('checked')
      if(e.target.getAttribute('checked') === "") {
        console.log('réinscrire stagiaire')
        let idNewUser = e.target.dataset.id_user
        console.log(idNewUser)
        let idSessionNewUser = document.querySelector('#session').value
        console.log(idSessionNewUser)
        //faire fetch d'inscription'
        fetch(urlApi + '/inscription/', {
      method: 'POST',
      headers: {'Content-Type' : 'application/json'},
      body: JSON.stringify({
        id_user: idNewUser,
        id_session: idSessionNewUser
      })
    })
    .then(response => response.json())
    .then(response => {
      console.log(response)
    })
    .catch(error =>console.log(error))
      } else {
        console.log('désinscrire stagiaire')
        // faire fetch de suppression
        //fetch(urlApi+ 'inscription/del/' + /*id_inscription*/)
      }
    }
  })

const nouveauStagiaire = document.querySelector('.searchResult')
nouveauStagiaire.addEventListener('click', e => {
  if(e.target.classList.contains('checkboxes')) {
      e.target.toggleAttribute('checked')
      if(e.target.getAttribute('checked') === "") {
        console.log('nouveau stagiaire inscrit')
        let idNewUser = e.target.dataset.id_user
        console.log(idNewUser)
        let idSessionNewUser = document.querySelector('#session').value
        console.log(idSessionNewUser)
        //faire fetch de réinscription
        fetch(urlApi + '/inscription/', {
      method: 'POST',
      headers: {'Content-Type' : 'application/json'},
      body: JSON.stringify({
        id_user: idNewUser,
        id_session: idSessionNewUser
      })
    })
    .then(response => response.json())
    .then(response => {
      console.log(response)
    })
    .catch(error =>console.log(error))
      } else {
        console.log('nouveau stagiaire désinscrit')
        // faire fetch de suppression
      }
    }
})


  </script>
</body>
</html>